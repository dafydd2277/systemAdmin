# Adding a Kickstart File to an ISO

The good news is that I ran through these steps so many times in testing, that
I gave up and wrote the `isoBuilder.sh` script in this directory to automate
everything.

## Steps

### Set your Environment

```
df_source_iso=/tmp/CentOS-8.3.2011-x86_64-dvd1.iso
d_source_mountpoint=/mnt

df_kickstart=/run/media/drastic/flashDrive/ks.cfg

df_dest_iso=/home/CentOS-8.3-2011-x86_64-ks.iso
d_build_dir=/home/iso
d_usb_device=/dev/sdb

mount -o loop ${df_source_iso} ${d_source_mountpoint}
```

Use `blkid` to get the LABEL of the DVD iso. This will provide the LABEL
information for the `mkisofs` command's `-V` argument, later. If you go looking
in the `isolinux/isolinux.cfg` and `EFI/BOOT/grub.cfg` files, you'll notice
that the installers refer to the DVD/USB drive by this LABEL.

```
blkid /dev/loop0
```


### Create and Populate a Working Directory

```
shopt -s dotglob

mkdir -p ${d_build_dir}
cp -avRfp ${d_source_iso_mountpoint}/* ${d_build_dir}/
```

Enabling the dotglob option allows the '*' wildcard to include dot files. If a
ISO image does not include `.discinfo`, the disk's stage2 won't load, and the
customized image won't installable. Therefore, verify all hidden files, like `.discinfo` and `.treeinfo`, have been copied over.

```
ls -al
```


### Add the Kickstart File

```
cp ${df_kickstart} ${d_iso_build}/ks.cfg
```


###  Modify the Boot Files

These two commands will add `ks=cdrom:/ks.cfg` to the end of each `append` line
in the menu section of `${d_build_dir}/isolinux.cfg`, and add
`inst.ks=cdrom:/ks.cfg` to the end of each `linuxefi` line in
`${d_iso_build}/EFI/BOOT/grub.cfg`. Then, the respective `diff` commands will
verify the modifications.

```
sed --in-place=.orig \
  "/append/ s/$/ ks=cdrom:\/ks.cfg/" \
  ${d_build_dir}/isolinux/isolinux.cfg
diff \
  ${d_build_dir}/isolinux/isolinux.cfg.orig \
  ${d_build_dir}/isolinux/isolinux.cfg

sed --in-place=.orig \
  "/linuxefi/ s/$/ inst.ks=cdrom:\/ks.cfg/" \
  ${d_build_dir}/EFI/BOOT/grub.cfg
diff \
  ${d_build_dir}/EFI/BOOT/grub.cfg.orig \
  ${d_build_dir}/EFI/BOOT/grub.cfg
```


You'll have a total of four modified `append` lines, and four modified
`linuxefi` lines.


### Create the ISO

Replace the `LABEL` in the `-V` argument with the LABEL given from the `blkid`
command back at the start of these notes.

```
cd ${d_iso_build}

cd ${d_build_dir}
time mkisofs \
  -o ${df_dest_iso} \
  -b isolinux/isolinux.bin \
  -J -R -l -v \
  -c isolinux/boot.cat \
  -no-emul-boot \
  -boot-load-size 4 \
  -boot-info-table \
  -eltorito-alt-boot \
  -e images/efiboot.img \
  -no-emul-boot \
  -graft-points \
  -V "LABEL" \
  -jcharset utf-8 .


isohybrid --uefi ${df_dest_iso}
implantisomd5 ${df_dest_iso}

```

Notes:
1. Don't forget the dot (`.`) at the end of the `mkisofs` command.
1. The `-boot-info-table` argument will modify one of the files in the
`isolinux/` directory. So, if you have trouble with these last steps, your
safest bet is to delete the entire copy of the generic ISO, and recopy the
files from the ISO file. To that end, having a copy of `ks.cfg` can't hurt.
1. Yes, you need two instances of `-no-emul-boot`. No, I haven't figured out
enough black magic to explain why. All of attempts to figure out `mkisofs`
boiled down to "type it exactly as it's given." I gave up on attempts to put
the arguments in any sort of lexical order. [This Red Hat blog post][blog] was
the point where I gave up and [JRTI][]'ed.
1. The `isohybrid` and `implantisomd5` commands need to be in that order so the
modifications made by `isohybrid` don't break the md5 hashes generated by
`implantisomd5`. And you need `implantisomd5` for the installer to do its disk
health checks. (And yes, that was a **headdesk** moment. D'you see this bruise
in the middle of my forehead?...)

[blog]: https://www.redhat.com/sysadmin/optimized-iso-image
[JRTI]: https://www.space.com/28445-spacex-elon-musk-drone-ships-names.html


Once the dd is complete, you can remove the USB flash drive and attempt to use
it to install the OS on another computer.
